<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scraper + AI JSON</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f7fa; margin:0; padding:0;}
.container { max-width:900px; margin:40px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1);}
h2{text-align:center;color:#333;}
input[type=text]{width:70%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-right:10px;font-size:16px;}
button{padding:10px 20px;font-size:16px;border-radius:8px;border:none;background:#4f46e5;color:#fff;cursor:pointer;transition:0.3s;}
button:hover{background:#4338ca;}
pre{white-space:pre-wrap;border:1px solid #ddd;padding:15px;border-radius:8px;background:#f9fafb;max-height:500px;overflow-y:auto;font-size:14px;}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #4f46e5;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;margin-right:10px;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.status{margin-top:15px;font-weight:bold;color:#555;display:flex;align-items:center;}
</style>
</head>
<body>

<div class="container">
<h2>Scraper + AI JSON Terminal</h2>
<div style="text-align:center; margin-bottom:15px;">
<input type="text" id="url" placeholder="Masukkan URL target">
<button onclick="startScrape()">Fetch & Analyze</button>
</div>

<div class="status" id="status"></div>
<pre id="terminal">Terminal output akan muncul di sini...</pre>

<script>
async function startScrape() {
  const url = document.getElementById('url').value;
  const statusEl = document.getElementById('status');
  const term = document.getElementById('terminal');
  term.textContent = '';
  statusEl.innerHTML = `<div class="spinner"></div>Initializing scraper...`;

  if (!url) return alert('Masukkan URL dulu!');

  try {
    term.textContent += `[1/4] Fetching HTML content...\n`;
    statusEl.innerHTML = `<div class="spinner"></div>Fetching HTML...`;

    const fetchRes = await fetch('/api/fetch', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({url})
    });
    const fetchData = await fetchRes.json();
    if (!fetchData.html) throw new Error("Failed to fetch HTML");
    term.textContent += `✓ [1/4] HTML fetched successfully\n`;

    const html = fetchData.html;
    term.textContent += `[2/4] Processing HTML content...\n`;
    statusEl.innerHTML = `<div class="spinner"></div>Processing HTML...`;

    const analyzeRes = await fetch('/api/analyze', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({html})
    });

    const reader = analyzeRes.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let done = false;
    let fullText = '';
    let chunkCount = 0;

    term.textContent += `[3/4] Analyzing content with AI...\n`;
    statusEl.innerHTML = `<div class="spinner"></div>Analyzing AI...`;

    // baca stream progres dari backend (opsional jika backend kirim partial)
    while(!done){
      const {value, done:doneReading} = await reader.read();
      done = doneReading;
      if(value){
        const text = decoder.decode(value);
        fullText += text;
        // update terminal live
        const newLines = text.split('\n').filter(l=>l.trim());
        newLines.forEach(line=>{
          if(line.includes('Chunk')) chunkCount++;
          term.textContent += line+'\n';
        });
      }
    }

    statusEl.textContent = "✅ [4/4] Process completed";
    term.textContent += `\nAnalysis complete. JSON summary ready.\n\n`;
    term.textContent += fullText; // tampilkan full JSON hasil AI

  } catch(err){
    statusEl.textContent = "❌ Terjadi kesalahan: " + err.message;
    term.textContent += `\nError: ${err.message}`;
  }
}
</script>

</body>
</html>
